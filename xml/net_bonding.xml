<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE sect1 [
<!ENTITY % entities SYSTEM "entity-decl.ent">
%entities;
]>
<sect1 xmlns="http://docbook.org/ns/docbook" xmlns:xi="http://www.w3.org/2001/XInclude" xmlns:xlink="http://www.w3.org/1999/xlink" version="5.0" xml:id="sec.network.iface-bonding">
 <title>ボンディングデバイスの設定</title>

 <info>
  <dm:docmanager xmlns:dm="urn:x-suse:ns:docmanager">
   <dm:bugtracker/>
   <dm:translation>yes</dm:translation>
  </dm:docmanager>
 </info>

 <para>システムによっては、一般的なイーサネットデバイスにおける標準的なセキュリティや可用性の要件を越えて、ネットワーク接続を実装する要望がある場合があります。このような場合は、複数のイーサネットデバイスをまとめて、 1 つのボンディングデバイスにすることができます。</para>

 <para>ボンディングデバイスの設定は、ボンディングモジュールを設定して行ないます。また、このモジュールの動作はモードによって切り替えることができます。既定では <systemitem>active-backup</systemitem> (アクティブ-バックアップ) モードに設定されていて、一方のデバイスに障害が発生した場合に、他方のデバイスに切り替える動作を行ないます。モードには下記の設定が用意されています:</para>

 <variablelist>
  <varlistentry>
   <term><guimenu>0</guimenu> (balance-rr)</term>
   <listitem>
    <para>パケットはラウンドロビン形式で、最初のインターフェイスから最後のインターフェイスまで、パケットを 1 つずつ送りながらインターフェイスを切り替える動作になります。これにより、冗長化と負荷分散の両方を実現することができます。</para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>1</guimenu> (active-backup)</term>
   <listitem>
    <para>いずれか 1 つのネットワークインターフェイスのみを有効に設定します。そのネットワークインターフェイスに障害が発生すると、異なるインターフェイスが有効化されます。この設定は &productname; における既定値で、冗長化のみを実現することができます。</para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>2</guimenu> (balance-xor)</term>
   <listitem>
    <para>パケットは下記のポリシーを利用して、利用可能な全てのインターフェイスに分散されます: <literal>[({送信元 MAC アドレス} XOR {送信先 MAC アドレス} XOR {パケットタイプ ID}) をインターフェイス数で割った余り]</literal> 。接続するスイッチ側での対応が必要です。冗長化と負荷分散の両方を提供します。</para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>3</guimenu> (broadcast)</term>
   <listitem>
    <para>全てのパケットを全てのインターフェイスに送信します。接続するスイッチ側での対応が必要です。冗長化のみを実現することができます。</para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>4</guimenu> (802.3ad)</term>
   <listitem>
    <para>同じ速度と二重通信方式を共有する複数のインターフェイスを、 1 つにまとめる設定です。インターフェイスドライバ側に <command>ethtool</command> のサポートが必要となるほか、接続するスイッチ側で IEEE 802.3ad 動的リンク集約の設定を行なう必要があります。冗長化と負荷分散の両方を提供します。</para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>5</guimenu> (balance-tlb)</term>
   <listitem>
    <para>順応型送信負荷分散を行ないます。インターフェイスドライバ側に <command>ethtool</command> のサポートが必要となりますが、スイッチ側での対応は不要です。冗長化と負荷分散の両方を提供します。</para>
   </listitem>
  </varlistentry>
  <varlistentry>
   <term><guimenu>6</guimenu> (balance-alb)</term>
   <listitem>
    <para>順応型負荷分散を行ないます。インターフェイスドライバ側に <command>ethtool</command> のサポートが必要となりますが、スイッチ側での対応は不要です。冗長化と負荷分散の両方を提供します。</para>
   </listitem>
  </varlistentry>
 </variablelist>

 <para>モードに関する詳細な説明については、 <link xlink:href="https://www.kernel.org/doc/Documentation/networking/bonding.txt"/> をお読みください。</para>

 <tip>
  <title>ボンディングと &xen;</title>
  <para>ボンディングデバイスの使用は、複数のネットワークカードを接続しているマシンでのみ設定することができる仕様です。ほとんどの設定において、ボンディングデバイスは &dom0; でのみ使用すべきものであることを意味します。 &vmguest; システムに対して複数のネットワークカードを割り当てている場合にのみ、 &vmguest; 内でボンディングを設定することができることになります。</para>
 </tip>

 <para>ボンディングデバイスを設定するには、下記の手順で行ないます:</para>

 <procedure>
  <step>
   <para><menuchoice><guimenu>&yast;</guimenu> <guimenu>システム</guimenu> <guimenu>ネットワークの設定</guimenu></menuchoice> を実行します。</para>
  </step>
  <step>
   <para><guimenu>追加</guimenu> を押し、 <guimenu>デバイスの種類</guimenu> に <guimenu>ボンド</guimenu> を選択して、 <guimenu>次へ</guimenu> を押します。</para>
   <informalfigure>
    <mediaobject>
     <imageobject role="fo">
      <imagedata fileref="bond_configuration.png" width="70%" format="PNG"/>
     </imageobject>
     <imageobject role="html">
      <imagedata fileref="bond_configuration.png" width="65%" format="PNG"/>
     </imageobject>
    </mediaobject>
   </informalfigure>
  </step>
  <step>
   <para>ボンディングデバイスへの IP アドレスの割り当て方法を指定します。下記の 3 種類の中から選択します:</para>
   <itemizedlist mark="bullet" spacing="normal">
    <listitem>
     <para>IP の設定無し</para>
    </listitem>
    <listitem>
     <para>可変 IP アドレス (DHCP もしくは Zeroconf)</para>
    </listitem>
    <listitem>
     <para>固定 IP アドレス</para>
    </listitem>
   </itemizedlist>
   <para>お使いの環境に適切なものを選択してください。</para>
  </step>
  <step>
   <para>また、 <guimenu>ボンドスレーブ</guimenu> のタブでは、ボンディングデバイスに含めるべきインターフェイスを、チェックボックスで選択します。</para>
  </step>
  <step>
   <para><guimenu>ボンドドライバのオプション</guimenu> を編集して、モードを設定します。</para>
  </step>
  <step>
   <para>なお、 <guimenu>ボンドドライバのオプション</guimenu> の末尾に <literal>miimon=100</literal> のパラメータが存在していることを確認してください。このパラメータを指定しないと、定期的なチェックが行なわれなくなります。</para>
  </step>
  <step>
   <para><guimenu>Next</guimenu> を押して進み、 <guimenu>OK</guimenu> を押して &yast; を終了すると、デバイスを作成することができます。</para>
  </step>
 </procedure>

 <sect2 xml:id="sec.network.iface-bonding.hotplug">
  <title>ボンドスレーブのホットプラグ</title>
  <para>ネットワーク環境 (たとえば高可用性が必要な環境) によっては、障害の発生したネットワークインターフェイスを別のものに交換する必要がある場合があります。このような要件を満たすには、ボンドスレーブのホットプラグを設定して解決する必要があります。</para>
  <para>ボンディングの設定を通常通りに行ないます (詳しくは <command>man 5 ifcfg-bonding</command> をお読みください) 。たとえば下記のようになります:</para>
<screen>ifcfg-bond0
          STARTMODE='auto' # or 'onboot'
          BOOTPROTO='static'
          IPADDR='192.168.0.1/24'
          BONDING_MASTER='yes'
          BONDING_SLAVE_0='eth0'
          BONDING_SLAVE_1='eth1'
          BONDING_MODULE_OPTS='mode=active-backup miimon=100'</screen>
  <para>スレーブ側には <literal>STARTMODE=hotplug</literal> と <literal>BOOTPROTO=none</literal> を指定します:</para>
<screen>ifcfg-eth0
          STARTMODE='hotplug'
          BOOTPROTO='none'

ifcfg-eth1
          STARTMODE='hotplug'
          BOOTPROTO='none'</screen>
<!-- fs 2014-06-23: The eth nameing scheme will stay
  <para>
   Check the device name&mdash;maybe you need to replace
   <literal>eth0</literal> and <literal>eth1</literal> with
   <literal>ens3</literal> and <literal>ens4</literal>.
  </para>
-->
  <para><literal>BOOTPROTO=none</literal> を指定すると、 <command>ethtool</command> を使用して設定が行なわれますが、 <command>ifup eth0</command> で起動が行なわれなくなります。これはスレーブインターフェイスはボンドマスター側で制御されるべきであるためです。</para>
  <para><literal>STARTMODE=hotplug</literal> を指定すると、スレーブインターフェイスが利用可能な状態になった際に、自動的にボンディングデバイスに参加するようになります。</para>
  <para>また、 <filename>/etc/udev/rules.d/70-persistent-net.rules</filename> 内にある <systemitem>udev</systemitem> のルールを、 MAC アドレスではなくバス ID を指定する形式に変更する必要があります (udev の <systemitem>KERNELS</systemitem> キーに、 <command>hwinfo --netcard</command> で出力される "SysFS のバス ID"を指定します) 。これにより、障害の発生したハードウエア (同じスロットにありながら、 MAC アドレスの異なるハードウエア) を交換することができるようになり、 MAC アドレスが変更されることによるボンドドライバ側の問題を回避できるようになります。</para>
  <para>たとえば下記のようになります:</para>
<screen>SUBSYSTEM=="net", ACTION=="add", DRIVERS=="?*",
KERNELS=="0000:00:19.0", ATTR{dev_id}=="0x0", ATTR{type}=="1",
KERNEL=="eth*", NAME="eth0"</screen>
  <para>システムの起動時点では、 systemd の <systemitem>network.service</systemitem> はホットプラグ指定されたスレーブを待機しませんが、ボンドインターフェイスを動作させるためには、少なくとも 1 つ以上のスレーブが必要となります。スレーブインターフェイスのいずれかが取り外される (NIC ドライバからバインド解除される、つまり NIC のドライバが <command>rmmod</command> されるか、 PCI ホットプラグで取り外される) と、カーネルはボンドデバイスについても自動的に削除を行ないます。新しいカードがシステムに接続される (置き換えとして同じスロットに接続される) と、 <systemitem>udev</systemitem> はバス ID ベースの固定名をスレーブに付与して <command>ifup</command> を呼び出します。 <command>ifup</command> 側では、ボンドデバイス側への参加を自動的に行ないます。<remark> ke: I think this can stay that way for now. </remark></para>
 </sect2>

<!--
  http://www.cyberciti.biz/howto/question/static/linux-ethernet-bonding-driver-howto.php
  - this is not as fresh as the kernel documentation!
  -->
</sect1>
